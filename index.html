<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Funcion√°rios</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">
    <script src="https://cdn.plotly.js/plotly-2.24.1.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f8f9fa; 
            padding: 20px; 
            margin: 0;
            color: #333;
        }
        h1 { 
            text-align: center; 
            color: #2c3e50; 
            margin-bottom: 30px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .summary { 
            display: flex; 
            flex-wrap: wrap;
            justify-content: space-around; 
            margin-bottom: 30px; 
            padding: 20px; 
            background-color: white; 
            border-radius: 10px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .summary-item { 
            text-align: center; 
            padding: 15px;
            min-width: 200px;
            flex: 1;
        }
        .summary-item h3 {
            color: #7f8c8d;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .summary-item h4 {
            color: #2c3e50;
            font-size: 24px;
            margin: 0;
        }
        .filters { 
            margin-bottom: 20px; 
            padding: 20px; 
            background-color: white; 
            border-radius: 10px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .filters label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #2c3e50;
        }
        .filters select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            height: 100px; /* Altura para sele√ß√£o m√∫ltipla */
        }
        .graphs { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px; 
            margin-bottom: 20px;
        }
        .graphs > div { 
            background-color: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 400px;
        }
        .error {
            color: #e74c3c;
            padding: 20px;
            text-align: center;
            background-color: #fadbd8;
            border-radius: 5px;
            margin: 10px 0;
        }
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .graphs {
                grid-template-columns: 1fr;
            }
            .summary {
                flex-direction: column;
            }
            .summary-item {
                margin-bottom: 15px;
            }
            body {
                padding: 10px;
            }
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            width: 100%;
            position: relative;
        }
        .loading:after {
            content: '';
            display: block;
            width: 40px;
            height: 40px;
            border: 4px solid #3498db;
            border-radius: 50%;
            border-top-color: transparent;
            margin: 15px auto 0;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>Dashboard de Funcion√°rios</h1>
    <div class="summary" id="summary">
        <div class="loading">Carregando dados...</div>
    </div>
    <div class="filters">
        <label for="filtro-funcao">Filtrar por fun√ß√£o:</label>
        <select id="filtro-funcao" multiple></select>
    </div>
    <div class="graphs">
        <div id="grafico-salarios"></div>
        <div id="grafico-funcao"></div>
    </div>
    
    <footer>
        Dashboard criado com HTML, JavaScript e Plotly.js. <br>
        Dados atualizados automaticamente via Google Sheets. <br>
        Hospedado gratuitamente no GitHub Pages.
    </footer>

    <script>
        // URL da API do Google Sheets - Usando formato para CSV p√∫blico (mais simples)
        const SHEET_ID = '1_1PhYMBIpG3kS_lLsUD351VuB1J0K2d8';
        // CSV n√£o precisa de API key, apenas o ID da planilha
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;

        async function fetchData() {
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                return parseCSV(text);
            } catch (error) {
                console.error("Erro ao buscar dados:", error);
                document.getElementById('summary').innerHTML = 
                    `<div class="error">Erro ao carregar dados. Por favor, verifique se a planilha est√° p√∫blica.</div>`;
                return null;
            }
        }

        // Fun√ß√£o para converter CSV em array
        function parseCSV(text) {
            const lines = text.split('\n');
            return lines.map(line => {
                // Tratamento para lidar com v√≠rgulas dentro de aspas
                const result = [];
                let inQuotes = false;
                let currentValue = '';
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(currentValue);
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                
                result.push(currentValue);
                return result;
            });
        }

        async function createDashboard() {
            const data = await fetchData();
            if (!data || !data.length) {
                return; // Se n√£o h√° dados, sai da fun√ß√£o
            }
            
            // O resto do c√≥digo continua daqui...
            const headers = data[0];
            const rows = data.slice(1).filter(row => row.length >= 2); // Filtra linhas vazias ou incompletas
            
            // Encontra os √≠ndices corretos (tenta diferentes nomes de colunas poss√≠veis)
            const funcaoIndex = headers.indexOf('FUN√á√ÉO') !== -1 ? 
                               headers.indexOf('FUN√á√ÉO') : 
                               headers.findIndex(h => h.includes('FUNC'));
                               
            const salarioIndex = headers.indexOf('V. BRUTO') !== -1 ? 
                                headers.indexOf('V. BRUTO') : 
                                headers.findIndex(h => h.includes('BRUTO') || h.includes('SALARIO'));

            if (funcaoIndex === -1 || salarioIndex === -1) {
                document.getElementById('summary').innerHTML = 
                    `<div class="error">Colunas necess√°rias n√£o encontradas na planilha. Precisamos de colunas para "FUN√á√ÉO" e "V. BRUTO".</div>`;
                return;
            }

            const funcoes = [...new Set(rows.map(row => row[funcaoIndex]).filter(Boolean))];
            const totalFuncionarios = rows.length;
            const totalSalarios = rows.reduce((sum, row) => {
                const val = parseFloat(row[salarioIndex].replace(/[^\d.-]/g, '')) || 0;
                return sum + val;
            }, 0);
            const mediaSalarial = totalFuncionarios ? totalSalarios / totalFuncionarios : 0;

            document.getElementById('summary').innerHTML = `
                <div class="summary-item">
                    <h3>Total de Funcion√°rios</h3>
                    <h4>${totalFuncionarios}</h4>
                </div>
                <div class="summary-item">
                    <h3>Total da Folha de Pagamento</h3>
                    <h4>R$ ${totalSalarios.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h4>
                </div>
                <div class="summary-item">
                    <h3>M√©dia Salarial</h3>
                    <h4>R$ ${mediaSalarial.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h4>
                </div>
            `;

            const filtroFuncao = document.getElementById('filtro-funcao');
            filtroFuncao.innerHTML = ''; // Limpa o filtro antes de adicionar op√ß√µes
            funcoes.forEach(funcao => {
                if (funcao) { // Verifica se n√£o √© null ou undefined
                    const option = document.createElement('option');
                    option.value = funcao;
                    option.textContent = funcao;
                    filtroFuncao.appendChild(option);
                }
            });

            filtroFuncao.addEventListener('change', () => {
                const selectedFuncoes = Array.from(filtroFuncao.selectedOptions).map(option => option.value);
                updateCharts(rows, selectedFuncoes, funcaoIndex, salarioIndex);
            });

            updateCharts(rows, [], funcaoIndex, salarioIndex);
        }

        function updateCharts(rows, selectedFuncoes, funcaoIndex, salarioIndex) {
            const filteredRows = selectedFuncoes.length ? 
                rows.filter(row => row[funcaoIndex] && selectedFuncoes.includes(row[funcaoIndex])) : 
                rows;

            // Garante que temos dados para mostrar
            if (filteredRows.length === 0) {
                Plotly.newPlot('grafico-salarios', [], { title: 'Distribui√ß√£o Salarial (Sem dados)' });
                Plotly.newPlot('grafico-funcao', [], { title: 'Funcion√°rios por Fun√ß√£o (Sem dados)' });
                return;
            }

            const salarios = filteredRows.map(row => {
                const salarioStr = row[salarioIndex] || '0';
                return parseFloat(salarioStr.replace(/[^\d.-]/g, '')) || 0;
            }).filter(val => !isNaN(val) && val > 0);

            const trace1 = { 
                x: salarios, 
                type: 'histogram',
                marker: {
                    color: '#3498db'
                }
            };
            
            Plotly.newPlot('grafico-salarios', [trace1], { 
                title: 'Distribui√ß√£o Salarial',
                xaxis: { title: 'Sal√°rio (R$)' },
                yaxis: { title: 'N√∫mero de Funcion√°rios' }
            });

            const funcaoCounts = filteredRows.reduce((acc, row) => {
                const funcao = row[funcaoIndex];
                if (funcao) {
                    acc[funcao] = (acc[funcao] || 0) + 1;
                }
                return acc;
            }, {});
            
            const trace2 = { 
                x: Object.keys(funcaoCounts), 
                y: Object.values(funcaoCounts), 
                type: 'bar',
                marker: {
                    color: '#2ecc71'
                }
            };
            
            Plotly.newPlot('grafico-funcao', [trace2], { 
                title: 'Funcion√°rios por Fun√ß√£o',
                xaxis: { title: 'Fun√ß√£o' },
                yaxis: { title: 'N√∫mero de Funcion√°rios' }
            });
        }

        // Adiciona tratamento de erros global
        window.addEventListener('error', function(e) {
            console.error('Erro JavaScript:', e.message);
            document.getElementById('summary').innerHTML = 
                `<div class="error">Erro no dashboard: ${e.message}. Por favor, atualize a p√°gina ou contate o administrador.</div>`;
        });

        createDashboard();
    </script>
</body>
</html> 